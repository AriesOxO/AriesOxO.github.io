---
author: meow
comments: true
title: MySQL æ•°æ®è¯¯åˆ é™¤æ¢å¤æŒ‡å—ï¼šåˆ©ç”¨ Binlog æ—¥å¿—é€†è½¬ DELETE æ“ä½œ
categories:
  - MYSQL
tags:
  - æ•°æ®æ¢å¤
---

# MySQL æ•°æ®è¯¯åˆ é™¤æ¢å¤æŒ‡å—ï¼šåˆ©ç”¨ Binlog æ—¥å¿—é€†è½¬ DELETE æ“ä½œ

ä»Šå¤©æˆ‘ä»¬æ¥æ¢è®¨ä¸€ä¸ªå¸¸è§çš„æ•°æ®åº“é—®é¢˜ï¼šè¯¯åˆ é™¤æ•°æ®ã€‚MySQL ä½œä¸ºå¹¿æ³›ä½¿ç”¨çš„å…³ç³»å‹æ•°æ®åº“ï¼Œå¯ç”¨äº†äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinlogï¼‰åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¢å¤è¯¯åˆ é™¤çš„æ•°æ®ã€‚æœ¬æ–‡å°†ä»**å¦‚ä½•è·å–åˆ é™¤éƒ¨åˆ†çš„ Binlog æ—¥å¿—**å¼€å§‹ï¼Œé€æ­¥æŒ‡å¯¼ä½ å°† DELETE æ“ä½œè½¬æ¢ä¸º INSERT è¯­å¥ï¼Œå®ç°æ•°æ®æ¢å¤ã€‚æ•´ä¸ªè¿‡ç¨‹ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ Bash è„šæœ¬ï¼Œé«˜æ•ˆä¸”æ˜“äºæ“ä½œã€‚

æœ¬æ–‡ä»¥ä¸€ä¸ªè™šæ„çš„æµ‹è¯•è¡¨ `test_db.test_table` ä¸ºä¾‹ï¼Œæ¨¡æ‹Ÿè¯¯åˆ é™¤è®°å½•çš„æ¢å¤è¿‡ç¨‹ã€‚æ³¨æ„ï¼šæ¢å¤å‰ï¼Œè¯·ç¡®ä¿ MySQL å·²å¯ç”¨ Binlogï¼ˆ`log_bin` å‚æ•°ï¼‰ï¼Œå¹¶å¤‡ä»½æ•°æ®åº“ä»¥é˜²ä¸‡ä¸€ã€‚

## ä¸ºä»€ä¹ˆç”¨ Binlog æ¢å¤æ•°æ®ï¼Ÿ
Binlog æ˜¯ MySQL çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼Œè®°å½•äº†æ‰€æœ‰æ•°æ®åº“ä¿®æ”¹æ“ä½œï¼ˆå¦‚ INSERTã€UPDATEã€DELETEï¼‰ã€‚å®ƒä¸æ˜¯å¤‡ä»½ï¼Œä½†å¯ç”¨äºç‚¹å¯¹ç‚¹æ¢å¤ã€‚è¯¯åˆ é™¤åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è§£æ Binlog ä¸­çš„ DELETE äº‹ä»¶ï¼Œæå–è¢«åˆ è®°å½•çš„å€¼ï¼Œç”Ÿæˆå¯¹åº”çš„ INSERT è¯­å¥é‡æ–°æ’å…¥æ•°æ®åº“ã€‚

**ä¼˜ç‚¹**ï¼š
- æ— éœ€å®Œæ•´å¤‡ä»½ã€‚
- å¯é’ˆå¯¹ç‰¹å®šæ“ä½œæ¢å¤ã€‚
  **ç¼ºç‚¹**ï¼š
- éœ€è¦ Binlog æ–‡ä»¶å®Œæ•´ï¼Œæœªè¢«è¦†ç›–ï¼ˆå— `expire_logs_days` å‚æ•°å½±å“ï¼‰ã€‚
- æ“ä½œéœ€è°¨æ…ï¼Œé¿å…äºŒæ¬¡é”™è¯¯ã€‚

## æ­¥éª¤ 1: è·å–åˆ é™¤éƒ¨åˆ†çš„ Binlog æ—¥å¿—
é¦–å…ˆï¼Œä» MySQL æœåŠ¡å™¨è·å–åŒ…å«åˆ é™¤æ“ä½œçš„ Binlog æ–‡ä»¶ã€‚Binlog æ–‡ä»¶é€šå¸¸ä½äº MySQL æ•°æ®ç›®å½•ï¼ˆå¦‚ `/var/lib/mysql/`ï¼‰ï¼Œæ–‡ä»¶åå¦‚ `mysql-bin.000001`ã€‚

### 1.1 æŸ¥çœ‹å½“å‰ Binlog é…ç½®å’Œæ–‡ä»¶åˆ—è¡¨
åœ¨ MySQL å®¢æˆ·ç«¯æ‰§è¡Œï¼š
```sql
SHOW BINARY LOGS;
```
è¾“å‡ºç¤ºä¾‹ï¼š
```
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 |  1073741824 |
| mysql-bin.000002 |   52428800 |
+------------------+-----------+
```

æŸ¥çœ‹å½“å‰æ—¥å¿—ä½ç½®ï¼š
```sql
SHOW MASTER STATUS;
```
è¾“å‡ºç¤ºä¾‹ï¼š
```
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000002 | 12345678 |              |                  |
+------------------+----------+--------------+------------------+
```

### 1.2 å®šä½åˆ é™¤æ“ä½œçš„ Binlog éƒ¨åˆ†
è¯¯åˆ é™¤é€šå¸¸å‘ç”Ÿåœ¨ç‰¹å®šæ—¶é—´æ®µã€‚ä½¿ç”¨ `mysqlbinlog` å·¥å…·è§£æ Binlog æ–‡ä»¶ï¼ŒæŸ¥æ‰¾ DELETE æ“ä½œã€‚

- å®‰è£… `mysqlbinlog`ï¼šå®ƒæ˜¯ MySQL å®¢æˆ·ç«¯çš„ä¸€éƒ¨åˆ†ï¼Œé€šå¸¸é»˜è®¤å®‰è£…ã€‚
- è§£æå‘½ä»¤ç¤ºä¾‹ï¼ˆå‡è®¾åˆ é™¤å‘ç”Ÿåœ¨ 2025-09-24 14:32:00 å·¦å³ï¼ŒBinlog æ–‡ä»¶ä¸º `mysql-bin.000001`ï¼‰ï¼š
  ```bash
  mysqlbinlog --start-datetime="2025-09-24 14:30:00" --stop-datetime="2025-09-24 14:35:00" /path/to/mysql-bin.000001 > deleted_binlog.txt
  ```
  - `--start-datetime` å’Œ `--stop-datetime`ï¼šæŒ‡å®šæ—¶é—´èŒƒå›´è¿‡æ»¤ã€‚
  - å¦‚æœçŸ¥é“ç¡®åˆ‡ä½ç½®ï¼ˆä» `SHOW MASTER STATUS` è·å–ï¼‰ï¼Œå¯ç”¨ `--start-position` å’Œ `--stop-position`ï¼š
    ```bash
    mysqlbinlog --start-position=100000 --stop-position=100100 /path/to/mysql-bin.000001 > deleted_binlog.txt
    ```

è¾“å‡ºæ–‡ä»¶ `deleted_binlog.txt` ç¤ºä¾‹ï¼ˆè™šæ„çš„æµ‹è¯•è¡¨æ•°æ®ï¼‰ï¼š
```
BEGIN
/*!*/;
# at 100000
#250924 14:32:46 server id 1  end_log_pos 100050 CRC32 0x12345678  Table_map: `test_db`.`test_table` mapped to number 999
# at 100050
#250924 14:32:46 server id 1  end_log_pos 100080 CRC32 0x87654321  Delete_rows: table id 999 flags: STMT_END_F
### DELETE FROM `test_db`.`test_table`
### WHERE
###   @1=1
###   @2='TEST001'
###   @3='ZYTEST001'
###   @4='æµ‹è¯•è®°å½•'
###   @5=1
###   @6='T123.456'
###   @7=4
###   @8=9
###   @9=1
###   @10=0
###   @11=1753241236
###   @12=1753241236
# at 100080
#250924 14:32:46 server id 1  end_log_pos 100100 CRC32 0xabcdef12  Xid = 99999
COMMIT/*!*/;
```

**æµ‹è¯•è¡¨ç»“æ„**ï¼ˆå‚è€ƒï¼‰ï¼š
```sql
CREATE TABLE `test_db`.`test_table` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `code1` varchar(32) NOT NULL,
  `code2` varchar(32) NOT NULL,
  `description` varchar(255) NOT NULL COMMENT 'è®°å½•æè¿°',
  `type1` int(1) NOT NULL COMMENT 'ç±»å‹1',
  `type2` varchar(30) NOT NULL COMMENT 'ç±»å‹2',
  `status1` int(1) NOT NULL COMMENT 'çŠ¶æ€1',
  `status2` int(1) NOT NULL COMMENT 'çŠ¶æ€2',
  `flag1` int(1) DEFAULT NULL COMMENT 'æ ‡å¿—1',
  `flag2` int(1) DEFAULT NULL COMMENT 'æ ‡å¿—2',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `code2_type2` (`code2`, `type2`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=100 DEFAULT CHARSET=utf8 COMMENT='æµ‹è¯•è¡¨';
```

å¦‚æœæœ‰å¤šä¸ª DELETE æ“ä½œï¼Œé‡å¤è¿‡æ»¤ä»¥è·å–æ‰€æœ‰ç›¸å…³ç‰‡æ®µï¼Œä¿å­˜ä¸ºçº¯æ–‡æœ¬æ–‡ä»¶ï¼Œå¦‚ `rec.sql`ã€‚

**æç¤º**ï¼šä½¿ç”¨ `--verbose` æˆ– `--base64-output=DECODE-ROWS` å‚æ•°ä½¿ `mysqlbinlog` è¾“å‡ºæ›´æ˜“è¯»ã€‚

## æ­¥éª¤ 2: è½¬æ¢ Binlog ä¸º INSERT è¯­å¥
æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª Bash è„šæœ¬ï¼ŒåŸºäº Awk è§£æ Binlogï¼Œæå– DELETE æ“ä½œçš„å€¼ï¼Œç”Ÿæˆ INSERT è¯­å¥ã€‚Awk æ¯” sed æ›´é€‚åˆå¤„ç†å¤šè¡Œç»“æ„åŒ–æ•°æ®ï¼Œé€»è¾‘æ¸…æ™°ä¸”æ˜“äºç»´æŠ¤ã€‚

### è„šæœ¬å†…å®¹ï¼ˆbinlog_to_insert.shï¼‰
å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ°æ–‡ä»¶ `binlog_to_insert.sh`ï¼Œå¹¶èµ‹äºˆæ‰§è¡Œæƒé™ï¼š
```bash
chmod +x binlog_to_insert.sh
```

```bash
#!/bin/bash

# è„šæœ¬åç§°: binlog_to_insert.sh
# æè¿°: å°† MySQL binlog DELETE è¯­å¥è½¬æ¢ä¸º INSERT INTO è¯­å¥ï¼Œå¹¶è¾“å‡ºåˆ°å¯æ‰§è¡Œçš„ SQL æ–‡ä»¶ã€‚
# ç”¨æ³•: ./binlog_to_insert.sh <input_binlog_file> <output_sql_file>
# ç¤ºä¾‹: ./binlog_to_insert.sh rec.sql output_insert.sql

# æ£€æŸ¥å‚æ•°æ•°é‡
if [ $# -ne 2 ]; then
    echo "ç”¨æ³•: $0 <input_binlog_file> <output_sql_file>"
    exit 1
fi

INPUT_FILE="$1"
OUTPUT_FILE="$2"

# æ£€æŸ¥è¾“å…¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$INPUT_FILE" ]; then
    echo "é”™è¯¯: è¾“å…¥æ–‡ä»¶ '$INPUT_FILE' ä¸å­˜åœ¨ã€‚"
    exit 1
fi

# æ¸…ç©ºè¾“å‡ºæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
> "$OUTPUT_FILE"

# ä½¿ç”¨ awk å¤„ç†è¾“å…¥æ–‡ä»¶å¹¶ç”Ÿæˆ INSERT è¯­å¥
awk '
BEGIN {
    # åˆå§‹åŒ–å˜é‡
    table = "";
    values = "";
    collecting = 0;
}
# åŒ¹é… DELETE FROM è¡Œ
/### DELETE FROM/ {
    # æå–æ•°æ®åº“å’Œè¡¨å
    if (match($0, /### DELETE FROM `([^`]*)`\.`([^`]*)`/, arr)) {
        table = sprintf("INSERT INTO `%s`.`%s` (`id`, `code1`, `code2`, `description`, `type1`, `type2`, `status1`, `status2`, `flag1`, `flag2`, `update_time`, `create_time`) VALUES (", arr[1], arr[2]);
        values = "";
        collecting = 1;
    }
}
# åŒ¹é… @<number>=<value> è¡Œ
/###   @/ && collecting {
    # æå–å€¼
    if (match($0, /###   @[^=]*=(.*)/, val)) {
        value = val[1];
        # å¤„ç†å­—ç¬¦ä¸²å€¼ï¼ˆåŠ åŒå¼•å·ï¼‰
        if (value ~ /^'\''.*'\''$/) {
            sub(/^'\''/, "\"", value);
            sub(/'\''$/, "\"", value);
        }
        # å¤„ç†æ—¶é—´æˆ³å€¼ï¼ˆè½¬æ¢ä¸º FROM_UNIXTIMEï¼‰
        else if (value ~ /^[0-9]{10}$/) {
            value = sprintf("FROM_UNIXTIME(%s)", value);
        }
        # æ·»åŠ åˆ°å€¼åˆ—è¡¨
        values = values value ",";
    }
}
# åŒ¹é… COMMIT è¡Œ
/COMMIT/ && collecting {
    # æ£€æŸ¥æ˜¯å¦æ”¶é›†åˆ°å€¼
    if (values != "") {
        # ç§»é™¤æœ«å°¾é€—å·
        sub(/,$/, "", values);
        # è¾“å‡ºå®Œæ•´çš„ INSERT è¯­å¥
        print table values ");" >> "'"$OUTPUT_FILE"'";
    } else {
        print "-- è­¦å‘Š: æ²¡æœ‰æ”¶é›†åˆ°æœ‰æ•ˆå€¼ï¼Œè·³è¿‡æ­¤ INSERT è¯­å¥" >> "'"$OUTPUT_FILE"'";
    }
    # é‡ç½®å˜é‡
    table = "";
    values = "";
    collecting = 0;
}
' "$INPUT_FILE"

# æ£€æŸ¥è¾“å‡ºæ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
if [ $? -eq 0 ] && [ -s "$OUTPUT_FILE" ]; then
    echo "è½¬æ¢å®Œæˆã€‚è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE"
    echo "æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œ SQL æ–‡ä»¶ï¼šmysql -u <username> -p <database> < $OUTPUT_FILE"
else
    echo "è½¬æ¢å¤±è´¥ã€‚è¯·æ£€æŸ¥è¾“å…¥æ–‡ä»¶æ ¼å¼æˆ–å†…å®¹æ˜¯å¦æ­£ç¡®ã€‚"
    echo "å¯èƒ½çš„åŸå› ï¼š"
    echo "1. è¾“å…¥æ–‡ä»¶ '$INPUT_FILE' ç¼ºå°‘æœ‰æ•ˆçš„ DELETE è¯­å¥æˆ–å€¼ã€‚"
    echo "2. è¾“å…¥æ–‡ä»¶æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼ˆä¾‹å¦‚ç¼ºå°‘ COMMIT æˆ– @1 åˆ° @12 çš„å€¼ï¼‰ã€‚"
    echo "3. è¾“å…¥æ–‡ä»¶ä¸­å¯èƒ½æœ‰éé¢„æœŸçš„å­—ç¬¦æˆ–æ ¼å¼ã€‚"
    echo "è¯·æ£€æŸ¥è¾“å…¥æ–‡ä»¶å†…å®¹å¹¶ç¡®ä¿å…¶ä¸ç¤ºä¾‹æ ¼å¼ä¸€è‡´ã€‚"
    exit 1
fi
```

### è¿è¡Œè„šæœ¬
å‡è®¾ Binlog ç‰‡æ®µä¿å­˜åœ¨ `rec.sql`ï¼Œè¿è¡Œï¼š
```bash
./binlog_to_insert.sh rec.sql output_insert.sql
```

è¾“å‡ºæ–‡ä»¶ `output_insert.sql` å°†åŒ…å«ï¼š
```sql
INSERT INTO `test_db`.`test_table` (`id`, `code1`, `code2`, `description`, `type1`, `type2`, `status1`, `status2`, `flag1`, `flag2`, `update_time`, `create_time`) VALUES (1,"TEST001","ZYTEST001","æµ‹è¯•è®°å½•",1,"T123.456",4,9,1,0,FROM_UNIXTIME(1753241236),FROM_UNIXTIME(1753241236));
```

è„šæœ¬æ”¯æŒå¤„ç†å¤šä¸ª DELETE è¯­å¥å—ï¼Œç”Ÿæˆå¤šä¸ª INSERT è¯­å¥ã€‚

## æ­¥éª¤ 3: æ‰§è¡Œæ¢å¤ SQL
åœ¨ MySQL å®¢æˆ·ç«¯æˆ–å‘½ä»¤è¡Œæ‰§è¡Œç”Ÿæˆçš„ SQLï¼š
```bash
mysql -u root -p test_db < output_insert.sql
```
- éªŒè¯æ•°æ®æ˜¯å¦æ¢å¤ï¼š
  ```sql
  SELECT * FROM test_db.test_table WHERE id=1;
  ```
- æ³¨æ„ï¼šå¦‚æœè¡¨æœ‰ AUTO_INCREMENT ä¸»é”®ï¼Œè„šæœ¬ä¿ç•™åŸå§‹ IDï¼Œé¿å…å†²çªã€‚

## æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ
- **æµ‹è¯•ç¯å¢ƒ**ï¼šåœ¨æµ‹è¯•æ•°æ®åº“ä¸­éªŒè¯æ¢å¤è¿‡ç¨‹ï¼Œé¿å…å½±å“ç”Ÿäº§ç¯å¢ƒã€‚
- **æ—¶é—´æˆ³å¤„ç†**ï¼šè„šæœ¬å°† Unix æ—¶é—´æˆ³ï¼ˆå¦‚ `1753241236`ï¼‰è½¬æ¢ä¸º `FROM_UNIXTIME`ã€‚å¦‚æœä½ çš„æ—¶é—´æˆ³æ ¼å¼ä¸åŒï¼Œéœ€è°ƒæ•´è„šæœ¬ã€‚
- **å­—ç¬¦ç¼–ç **ï¼šç¡®ä¿ Binlog å’Œæ•°æ®åº“ç¼–ç ä¸€è‡´ï¼ˆå¦‚ UTF-8ï¼‰ï¼Œé¿å…ä¸­æ–‡ä¹±ç ï¼ˆå¦‚ `æµ‹è¯•è®°å½•`ï¼‰ã€‚
- **é¢„é˜²è¯¯åˆ **ï¼š
  - å¯ç”¨ Binlog å¤‡ä»½ã€‚
  - ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ“ä½œå¯å›æ»šã€‚
  - è®¾ç½®ä¸¥æ ¼çš„æƒé™æ§åˆ¶ã€‚
- **å·¥å…·ä¾èµ–**ï¼šè„šæœ¬ä¾èµ– Bash å’Œ Awkï¼Œåœ¨ Git Bash æˆ– WSL ä¸­è¿è¡Œè‰¯å¥½ã€‚
- **è°ƒè¯•æŠ€å·§**ï¼š
  - å¦‚æœè½¬æ¢å¤±è´¥ï¼Œæ£€æŸ¥ `rec.sql` æ˜¯å¦åŒ…å«å®Œæ•´ DELETE è¯­å¥ï¼ˆ`@1` åˆ° `@12` å’Œ `COMMIT`ï¼‰ã€‚
  - æŸ¥çœ‹éšè—å­—ç¬¦ï¼š
    ```bash
    cat -v rec.sql
    ```
    å¦‚æœå‘ç° Windows æ¢è¡Œç¬¦ (`^M`)ï¼Œè¿è¡Œï¼š
    ```bash
    dos2unix rec.sql
    ```

## æ•…éšœæ’é™¤
å¦‚æœè„šæœ¬å¤±è´¥ï¼š
1. **æ£€æŸ¥è¾“å…¥æ–‡ä»¶**ï¼šç¡®ä¿ `rec.sql` åŒ…å« `### DELETE FROM`ã€`@1` åˆ° `@12` å€¼è¡Œå’Œ `COMMIT`ã€‚
2. **æŸ¥çœ‹è¾“å‡º**ï¼šæ£€æŸ¥ `output_insert.sql` æ˜¯å¦ä¸ºç©ºï¼š
   ```bash
   cat output_insert.sql
   ```
3. **è°ƒè¯•è„šæœ¬**ï¼šåœ¨ `awk` åæ·»åŠ  `| tee /dev/stderr` æŸ¥çœ‹ä¸­é—´è¾“å‡ºï¼š
   ```bash
   awk '...' "$INPUT_FILE" | tee /dev/stderr >> "$OUTPUT_FILE"
   ```

å¸Œæœ›è¿™ç¯‡æŒ‡å—èƒ½å¸®ä½ è½»æ¾æ¢å¤è¯¯åˆ æ•°æ®ï¼ä¿æŒå¤‡ä»½ï¼Œè¿œç¦»è¯¯åˆ ï¼ğŸ˜Š

